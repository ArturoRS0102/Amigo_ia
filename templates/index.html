<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amigo IA - Un espacio para ti</title>
  <meta name="theme-color" content="#007bff">
  <meta name="description" content="Chat de contenci√≥n emocional con texto y voz">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%}body{font-family:'Inter',sans-serif;background:#f2f4f8;color:#212529;display:flex;justify-content:center;align-items:center}
    .chat-container{width:100%;max-width:750px;height:100vh;display:flex;flex-direction:column;background:#fff;border-radius:0;box-shadow:none;overflow:hidden;margin:0;position:relative}
    .chat-header{padding:1rem;background:#fff;border-bottom:1px solid #e9ecef;display:flex;align-items:center;justify-content:space-between}
    .header-info{display:flex;align-items:center;gap:.5rem}
    .logo{width:32px;height:32px;color:#007bff}
    .header-title h1{font-size:16px;margin:0}
    .header-title p{font-size:12px;margin:0;color:#6c757d}
    .disclaimer{font-size:12px;text-align:center;padding:.5rem;background:#fff9e6;border-bottom:1px solid #ffecb3;color:#594500}
    .chat-window{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.75rem}
    .message{max-width:80%;padding:.75rem 1rem;border-radius:1rem;line-height:1.5;animation:fadeIn .3s ease;opacity:0;transform:translateY(10px)}
    .message.user{align-self:flex-end;background:#e0f0ff;color:#005a9e;border-bottom-right-radius:.5rem}
    .message.ai{align-self:flex-start;background:#f1f3f5;color:#343a40;border-bottom-left-radius:.5rem}
    .typing-indicator{display:flex;align-self:flex-start;padding:.5rem;border-radius:1rem;gap:.3rem;background:#f1f3f5}
    .typing-indicator span{width:6px;height:6px;border-radius:50%;background:#b0b8c2;animation:bounce 1.2s infinite}
    @keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
    @keyframes fadeIn{to{opacity:1;transform:none}}
    .chat-input-area{padding:.75rem;border-top:1px solid #e9ecef;display:flex;gap:.5rem;background:#fff}
    #chat-input{flex:1;border:1px solid #dee2e6;border-radius:1rem;padding:.5rem 1rem;font-size:14px}
    button{border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer}
    #send-btn{background:#007bff;color:#fff}
    #voice-btn{background:#f1f3f5;color:#343a40}
    #restart-btn{background:#e9ecef;color:#6c757d;font-size:14px;padding:.3rem .75rem;border-radius:.75rem}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-info">
        <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 11.5C21 16.7467 16.7467 21 11.5 21C6.25329 21 2 16.7467 2 11.5C2 6.25329 6.25329 2 11.5 2" stroke="currentColor" stroke-width="2"/>
          <path d="M22 12.01V12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22H14" stroke="currentColor" stroke-width="2" stroke-dasharray="2 4"/>
        </svg>
        <div class="header-title">
          <h1>Amigo IA</h1>
          <p>Un espacio seguro para ti</p>
        </div>
      </div>
      <button id="restart-btn" title="Reiniciar conversaci√≥n">‚Ü∫</button>
    </div>
    <div class="disclaimer">Recuerda: esto no reemplaza atenci√≥n profesional.</div>
    <div class="chat-window" id="chat-window"></div>
    <div class="chat-input-area">
      <input type="text" id="chat-input" placeholder="Escribe lo que sientes..." />
      <button id="send-btn">‚û°Ô∏è</button>
      <button id="voice-btn">üé§</button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatWindow = document.getElementById('chat-window');
      const chatInput = document.getElementById('chat-input');
      const sendBtn = document.getElementById('send-btn');
      const restartBtn = document.getElementById('restart-btn');
      const voiceBtn = document.getElementById('voice-btn');
      let conversationHistory = [];
      let mediaRecorder, audioChunks = [];

      function addMessage(text, sender) {
        const el = document.createElement('div'); el.classList.add('message', sender);
        el.textContent = text; chatWindow.appendChild(el); chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      function showTyping(show) {
        let ind = document.getElementById('typing-indicator');
        if (show) {
          if (!ind) {
            ind = document.createElement('div'); ind.id='typing-indicator'; ind.className='typing-indicator';
            ind.innerHTML='<span></span><span></span><span></span>';
            chatWindow.appendChild(ind); chatWindow.scrollTop=chatWindow.scrollHeight;
          }
        } else if (ind) ind.remove();
      }

      async function fetchAI() {
        chatInput.disabled=sendBtn.disabled=true; showTyping(true);
        try {
          const res=await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({history:conversationHistory})});
          const data=await res.json(); showTyping(false);
          if(data.error) addMessage(`Error: ${data.error}`,'ai');
          else {addMessage(data.reply,'ai');conversationHistory.push({role:'assistant',content:data.reply});}
        } catch(e) {console.error(e);showTyping(false);addMessage('Lo siento, ocurri√≥ un error.','ai');}
        chatInput.disabled=sendBtn.disabled=false; chatInput.focus();
      }

      async function sendText() {
        const txt=chatInput.value.trim(); if(!txt)return; chatInput.value=''; addMessage(txt,'user'); conversationHistory.push({role:'user',content:txt}); await fetchAI();
      }

      voiceBtn.addEventListener('click',async()=>{if(!mediaRecorder){const stream=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder=new MediaRecorder(stream);
          mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=sendAudio;} if(mediaRecorder.state==='inactive'){audioChunks=[]; mediaRecorder.start(); voiceBtn.textContent='‚è∫Ô∏è'; setTimeout(()=>mediaRecorder.stop(),10000);}});

      async function sendAudio() {
        voiceBtn.textContent='üé§'; const blob=new Blob(audioChunks,{type:'audio/webm'}); const fd=new FormData(); fd.append('audio',blob,'voice.webm'); addMessage('Nota de voz enviada','user');
        try {showTyping(true);
          const res=await fetch('/audio',{method:'POST',body:fd}); const data=await res.json(); showTyping(false);
          if(data.transcript){addMessage(`Transcripci√≥n: ${data.transcript}`,'user'); conversationHistory.push({role:'user',content:data.transcript});}
          if(data.reply){addMessage(data.reply,'ai'); conversationHistory.push({role:'assistant',content:data.reply});}
        } catch(e) {console.error(e);showTyping(false);addMessage('Error al procesar audio.','ai');}
      }

      function startNew() {chatWindow.innerHTML=''; conversationHistory=[]; addMessage('Hola, soy tu Amigo IA. Estoy aqu√≠ para escucharte en un espacio seguro y sin juicios.','ai'); addMessage('¬øC√≥mo te sientes hoy?','ai'); chatInput.disabled=sendBtn.disabled=false; chatInput.focus();}

      sendBtn.addEventListener('click',sendText);
      chatInput.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();sendText();}});
      restartBtn.addEventListener('click',startNew);
      startNew();
    });
  </script>
</body>
</html>